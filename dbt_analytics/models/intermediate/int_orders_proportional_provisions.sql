-- GROSS ORDERS PER PRODUCT & MONTH APPLICABLE FOR PROPORTIONAL PROVISION

WITH CTE_GROSS_APPLICABLE_FOR_PROP_PROV AS (
	SELECT
		ORD.CREATION_MONTH
		,ORD.PRODUCT_NAME
		,ORD.CNT_ORDERS
		,PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
		,PROV.PROPORTIONAL_PROVISION_VALUE
	FROM {{ ref('int_orders_gross_net_agg_per_month') }} AS ORD
	INNER JOIN
		{{ ref('cre_provision_rules_proportional') }} AS PROV
		ON
			ORD.ORDER_TYPE = 'GROSS_ORDER'
			AND
			ORD.PRODUCT_NAME = PROV.PRODUCT_NAME
			AND
			ORD.CREATION_MONTH BETWEEN PROV.START_DATE AND PROV.END_DATE
			AND
			ORD.CNT_ORDERS > PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
)

-- NET ORDERS PER PRODUCT & MONTH APPLICABLE FOR PROPORTIONAL PROVISION
,CTE_NET_APPLICABLE_FOR_PROP_PROV AS (
	SELECT
		ORD.CREATION_MONTH
		,ORD.PRODUCT_NAME
		,ORD.CNT_ORDERS
		,PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
		,PROV.PROPORTIONAL_PROVISION_VALUE
	FROM {{ ref('int_orders_gross_net_agg_per_month') }} AS ORD
	INNER JOIN
		{{ ref('cre_provision_rules_proportional') }} AS PROV
		ON
			ORD.ORDER_TYPE = 'NET_ORDER'
			AND
			ORD.PRODUCT_NAME = PROV.PRODUCT_NAME
			AND
			ORD.CREATION_MONTH BETWEEN PROV.START_DATE AND PROV.END_DATE
			AND
			ORD.CNT_ORDERS > PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
)

,CTE_GROSS_ORDERS AS (
	SELECT
		ORDER_ID
		,CREATION_DATE
		,PRODUCT_NAME
		,DATE_TRUNC('MONTH',CREATION_DATE) AS CREATION_MONTH
	FROM
		{{ ref('int_orders_status_dates') }}
)

,CTE_NET_ORDERS AS (
	SELECT
		ORDER_ID
		,CREATION_DATE
		,PRODUCT_NAME
		,DATE_TRUNC('MONTH',CREATION_DATE) AS CREATION_MONTH
	FROM
		{{ ref('int_orders_status_dates') }}
	WHERE
		TRUE
		AND
		IS_CONFIRMED = TRUE
)

-- APPLY PROPORTIONAL PROVISION FOR GROSS ORDERS
,CTE_GROSS_ORDERS_PROP_PROV AS (
	SELECT
		CTE_GROSS_ORDERS.ORDER_ID
		,CTE_GROSS_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
		,CTE_GROSS_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_VALUE
		,ROW_NUMBER()
			OVER (
				PARTITION BY CTE_GROSS_ORDERS.PRODUCT_NAME,CTE_GROSS_ORDERS.CREATION_MONTH
				ORDER BY CTE_GROSS_ORDERS.CREATION_DATE,CTE_GROSS_ORDERS.ORDER_ID
			)
			AS IDX
		,CASE
			WHEN
				IDX > CTE_GROSS_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
				THEN CTE_GROSS_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_VALUE
			ELSE 0
		END AS PROPORTIONAL_PROVISION
	FROM
		CTE_GROSS_ORDERS
	INNER JOIN CTE_GROSS_APPLICABLE_FOR_PROP_PROV
		ON
			CTE_GROSS_ORDERS.PRODUCT_NAME = CTE_GROSS_APPLICABLE_FOR_PROP_PROV.PRODUCT_NAME
			AND CTE_GROSS_ORDERS.CREATION_MONTH = CTE_GROSS_APPLICABLE_FOR_PROP_PROV.CREATION_MONTH
)

-- APPLY PROPORTIONAL PROVISION FOR NET ORDERS
,CTE_NET_ORDERS_PROP_PROV AS (
	SELECT
		CTE_NET_ORDERS.ORDER_ID
		,CTE_NET_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
		,CTE_NET_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_VALUE
		,ROW_NUMBER()
			OVER (
				PARTITION BY CTE_NET_ORDERS.PRODUCT_NAME,CTE_NET_ORDERS.CREATION_MONTH
				ORDER BY CTE_NET_ORDERS.CREATION_DATE,CTE_NET_ORDERS.ORDER_ID
			)
			AS IDX
		,CASE
			WHEN
				IDX > CTE_NET_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_TARGET_VALUE
				THEN CTE_NET_APPLICABLE_FOR_PROP_PROV.PROPORTIONAL_PROVISION_VALUE
			ELSE 0
		END AS PROPORTIONAL_PROVISION
	FROM
		CTE_NET_ORDERS
	INNER JOIN CTE_NET_APPLICABLE_FOR_PROP_PROV
		ON
			CTE_NET_ORDERS.PRODUCT_NAME = CTE_NET_APPLICABLE_FOR_PROP_PROV.PRODUCT_NAME
			AND CTE_NET_ORDERS.CREATION_MONTH = CTE_NET_APPLICABLE_FOR_PROP_PROV.CREATION_MONTH
)

,CTE_GROSS_NET_ORDERS_PROP_PROV AS (
	SELECT
		CTE_GROSS_ORDERS_PROP_PROV.ORDER_ID
		,CTE_GROSS_ORDERS_PROP_PROV.PROPORTIONAL_PROVISION AS GROSS_PROPORTIONAL_PROVISION
		,COALESCE(CTE_NET_ORDERS_PROP_PROV.PROPORTIONAL_PROVISION,0) AS NET_PROPORTIONAL_PROVISION
	FROM
		CTE_GROSS_ORDERS_PROP_PROV
	LEFT OUTER JOIN
		CTE_NET_ORDERS_PROP_PROV
		ON
			CTE_GROSS_ORDERS_PROP_PROV.ORDER_ID = CTE_NET_ORDERS_PROP_PROV.ORDER_ID
)

SELECT
	ORDER_ID
	,GROSS_PROPORTIONAL_PROVISION
	,NET_PROPORTIONAL_PROVISION
FROM
	CTE_GROSS_NET_ORDERS_PROP_PROV
