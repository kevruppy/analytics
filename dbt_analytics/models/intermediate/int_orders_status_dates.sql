-- TODO: WE ALSO NEED TO DELETE IF ORDER TURNS OUT TO BE A TEST!

WITH CTE_ORDERS AS (
	SELECT
		ORDER_ID
		,PRODUCT_NAME
		,IS_PLACEMENT
		,MAX_BY(STATUS_NAME,STATUS_CHANGE_DATE) AS CURRENT_STATUS
		,MAX(CREATION_DATE) AS CREATION_DATE
		,MAX(CASE WHEN STATUS_NAME = 'IN_PROGRESS' THEN STATUS_CHANGE_DATE END) AS _FORWARDING_DATE
		,MAX(CASE WHEN STATUS_NAME = 'CONFIRMED' THEN STATUS_CHANGE_DATE END) AS CONFIRMATION_DATE
		,MAX(CASE WHEN STATUS_NAME = 'CANCELLED' THEN STATUS_CHANGE_DATE END) AS CANCELLATION_DATE
	FROM
		{{ ref('cre_orders') }}
	WHERE
		IS_TEST_ORDER = FALSE
	GROUP BY ALL
)

,CTE_ORDERS_STATUS_DATES AS (
	SELECT
		ORDER_ID
		,PRODUCT_NAME
		,IS_PLACEMENT
		,CURRENT_STATUS
		,CREATION_DATE
		,CONFIRMATION_DATE
		,CANCELLATION_DATE
		,CASE
			WHEN _FORWARDING_DATE IS NULL AND CONFIRMATION_DATE IS NOT NULL THEN CONFIRMATION_DATE
			WHEN _FORWARDING_DATE IS NULL AND CANCELLATION_DATE IS NOT NULL THEN CANCELLATION_DATE
			ELSE _FORWARDING_DATE
		END AS FORWARDING_DATE
		-- noqa: disable=ST02
		,CASE WHEN FORWARDING_DATE IS NOT NULL THEN TRUE ELSE FALSE END AS IS_FORWARDED
		,CASE WHEN CANCELLATION_DATE IS NOT NULL THEN TRUE ELSE FALSE END AS IS_CANCELLED
		,CASE WHEN CONFIRMATION_DATE IS NOT NULL THEN TRUE ELSE FALSE END AS IS_CONFIRMED
		-- noqa: enable=all
	FROM
		CTE_ORDERS
)

SELECT
	ORDER_ID
	,PRODUCT_NAME
	,IS_PLACEMENT
	,CURRENT_STATUS
	,CREATION_DATE
	,FORWARDING_DATE
	,CONFIRMATION_DATE
	,CANCELLATION_DATE
	,IS_FORWARDED
	,IS_CANCELLED
	,IS_CONFIRMED
FROM
	CTE_ORDERS_STATUS_DATES
