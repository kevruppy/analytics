WITH CTE_CAL AS (
	SELECT CALENDAR_DATE
	FROM
		{{ ref('stg_calendar') }} --noqa
	WHERE
		CALENDAR_DATE BETWEEN '2022-01-01' AND '2023-12-31'
)

,CTE_PRODUCTS AS (
	SELECT DISTINCT PRODUCT_NAME
	FROM
		{{ ref('mrt_orders') }}
)

,CTE_DIMS AS (
	SELECT COLUMNS(*) --noqa
	FROM
		CTE_CAL
	CROSS JOIN
		CTE_PRODUCTS
)

,CTE_ORD AS (
	SELECT
		CREATION_DATE
		,PRODUCT_NAME
		,COUNT(*) AS CNT
	FROM
		{{ ref('mrt_orders') }}
	GROUP BY
		ALL
)

,CTE_LONG AS (
	SELECT
		CTE_DIMS.*
		,CTE_ORD.CNT
	FROM
		CTE_DIMS
	LEFT OUTER JOIN
		CTE_ORD
		ON
			CTE_DIMS.CALENDAR_DATE = CTE_ORD.CREATION_DATE
			AND
			CTE_DIMS.PRODUCT_NAME = CTE_ORD.PRODUCT_NAME
)

-- WIDE TABLE FOR EASIER ANALYSIS

PIVOT CTE_LONG
ON PRODUCT_NAME
USING SUM(CNT)
GROUP BY CALENDAR_DATE
